## Substreams CLI & Lib Release

## Instructions

> *Important* Do not forget to replace `${version}` by your real version like `v0.0.21` in the commands below!

### Preparing for a release
- Ensure tests past go test ./...
- Ensure you are in a clean and pushed Git state
- Update the [./docs/release-notes/change-log.md](./docs/release-notes/change-log.md) to update the `## Unreleased` header to become `## [${version}](https://github.com/streamingfast/substreams/releases/tag/v${version})`
- Ensure that Keybase is running and you are logged in
- Commit everything with message `Preparing release of ${version}`.

## Generating a Draft release of  darwin amd64 & arm64

- `./bin/release.sh -f v${version}`

At this point we have created a release on Github that is in DRAFT, If you inspect that release you will notice that 
goreleaser created a darwin amd64 & arm64 binary. We will need to create a linux amd64 manual and upload it in the draft release before
we publish the release



## Generating a linux amd64 release

1) Create a linux build folder (note remove the 'v' from the version)
   - mkdir ./dist/substreams_${version}_linux_x86_64

1) Build a linux amd64 build with docker buildx
   - docker buildx build -f Dockerfile.build -t substreams-0.21 --load --platform=linux/amd64 .

1) Copy the binary out of the image
- docker run --rm sha256:<IMAGE_SHA_FROM_PRIOR_STEP> cat "/work/src/substreams" > ./dist/substreams_${version}_linux_x86_64

1) Copy the README.md & LICENSE
- cp README.md ./dist/substreams_${version}_linux_x86_64
- cp LICENSE ./dist/substreams_${version}_linux_x86_64

1) tar the linux build
- cd ./dist
- tar czf substreams_{version}_linux_x86_64.tar.gz substreams_{version}_linux_x86_64

## Finalizing Github release

- Go to https://github.com/streamingfast/substreams-rs/releases/tag/v${version} and update the release notes, use content of section `## [v${version}]` in [docs/release-notes/change-log.md](./docs/release-notes/change-log.md), edit GitHub release and paste content before commits listing, keep both:

  ```
  ## Changelog

  <Content from 'CHANGELOG.md' here>

  ### Commits

  <Auto-generated commits listing>
  ```
- Upload the linux_x86_64 tar gaz to the attachemnts section of the release
- Update the [docs/release-notes/change-log.md](./docs/release-notes/change-log.md) adding `## Unreleased` header on top of latest released section.
- Commit everything with message `Preparing next unreleased version`.
 
